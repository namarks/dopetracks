<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dopetracks Playlist Generator</title>
    <style>
        /* Add styling here */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        section {
            margin-bottom: 20px;
        }
        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        .status {
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Dopetracks Playlist Generator</h1>

    <!-- Setup Section -->
    <section>
        <h2>Setup</h2>
        <div id="spotify-auth">
            <p>Step 1: Authorize Spotify</p>
            <button id="authorizeSpotify">Authorize Spotify</button>
            <div id="spotifyStatus" class="status"></div>
        </div>
        <div id="username-validation">
            <p>Step 2: Validate MacOS Username</p>
            <input type="text" id="macUsername" placeholder="Enter your MacOS username">
            <button id="validateUsername">Validate Username</button>
            <div id="usernameStatus" class="status"></div>
        </div>
    </section>

    <!-- Chat Group Search Section -->
    <section>
        <h2>Chat Group Search</h2>
        <input type="text" id="chatSearch" placeholder="Search for chat name">
        <button id="searchChats">Search</button>
        <table id="chatTable">
            <thead>
                <tr>
                    <th>Chat Name</th>
                    <th># of Members</th>
                    <th># of Spotify URLs Sent</th>
                </tr>
            </thead>
            <tbody>
                <!-- Chat results will be dynamically added here -->
            </tbody>
        </table>
    </section>

    <!-- Playlist Creation Section -->
    <section id="playlistCreation" class="disabled">
        <h2>Playlist Creation</h2>
        <label for="playlistName">Playlist Name:</label>
        <input type="text" id="playlistName" placeholder="Enter playlist name">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
        <button id="createPlaylist">Create Playlist</button>
    </section>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
        // State variables to track progress
        let isSpotifyAuthorized = false;
        let isUsernameValidated = false;

        // Spotify Authorization
        const authorizeSpotifyButton = document.getElementById("authorizeSpotify");
        const spotifyStatus = document.getElementById("spotifyStatus");

        authorizeSpotifyButton.addEventListener("click", async () => {
            try {
                const response = await fetch("/get-client-id");
                const data = await response.json();
                if (data.client_id) {
                    const clientId = data.client_id;
                    const redirectUri =
                        window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost"
                            ? "http://localhost:8888/callback" // Local environment
                            : "https://your-production-domain.onrender.com/callback"; // Render environment
                    const scopes = "playlist-modify-public user-read-playback-state";
                    const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
                    window.location.href = authUrl;
                } else {
                    spotifyStatus.textContent = "Error: Spotify Client ID not found.";
                }
            } catch (error) {
                console.error(error);
                spotifyStatus.textContent = "Error authorizing Spotify.";
            }
        });

        // Check if Spotify was authorized (called after redirect)
        const urlParams = new URLSearchParams(window.location.search);
        const spotifyCode = urlParams.get("code");
        if (spotifyCode) {
            spotifyStatus.textContent = "✅ Spotify Authorized";
            isSpotifyAuthorized = true;
            enablePlaylistCreation();
        }

        // Username Validation
        const validateUsernameButton = document.getElementById("validateUsername");
        const macUsernameInput = document.getElementById("macUsername");
        const usernameStatus = document.getElementById("usernameStatus");

        validateUsernameButton.addEventListener("click", async () => {
            const username = macUsernameInput.value.trim();
            if (!username) {
                usernameStatus.textContent = "Please enter a valid username.";
                return;
            }

            usernameStatus.textContent = "Validating...";
            try {
                const response = await fetch(`/validate-username?username=${encodeURIComponent(username)}`);
                const data = await response.json();

                if (response.ok) {
                    usernameStatus.textContent = `✅ Username validated. iMessage database found at: ${data.filepath}`;
                    isUsernameValidated = true;
                    enablePlaylistCreation();
                } else {
                    usernameStatus.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                console.error(error);
                usernameStatus.textContent = "Error validating username.";
            }
        });

        // Enable Playlist Creation
        function enablePlaylistCreation() {
            if (isSpotifyAuthorized && isUsernameValidated) {
                document.getElementById("playlistCreation").classList.remove("disabled");
            }
        }

        // Chat Group Search
        const chatSearchInput = document.getElementById("chatSearch");
        const searchChatsButton = document.getElementById("searchChats");
        const chatTableBody = document.getElementById("chatTable").querySelector("tbody");

        searchChatsButton.addEventListener("click", async () => {
            const searchTerm = chatSearchInput.value.trim();
            if (!searchTerm) {
                alert("Please enter a search term.");
                return;
            }

            try {
                chatTableBody.innerHTML = ""; // Clear existing rows
                // Simulate fetching chat data (replace with actual API call)
                const chats = [
                    { name: "dope tracks", members: 7, urls: 31 },
                    { name: "music lovers", members: 5, urls: 20 },
                ]; // Example data

                chats.forEach((chat) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${chat.name}</td>
                        <td>${chat.members}</td>
                        <td>${chat.urls}</td>
                    `;
                    chatTableBody.appendChild(row);
                });
            } catch (error) {
                console.error(error);
                alert("Error searching for chats.");
            }
        });

        // Playlist Creation
        const createPlaylistButton = document.getElementById("createPlaylist");

        createPlaylistButton.addEventListener("click", async () => {
            const playlistName = document.getElementById("playlistName").value.trim();
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            if (!playlistName || !startDate || !endDate) {
                alert("Please fill out all fields.");
                return;
            }

            try {
                const response = await fetch("/upload-chat/", {
                    method: "POST",
                    body: new URLSearchParams({
                        username: macUsernameInput.value.trim(),
                        start_date: startDate,
                        end_date: endDate,
                        playlist_name: playlistName,
                    }),
                });
                const data = await response.json();

                if (response.ok) {
                    alert(`Playlist "${playlistName}" created successfully!`);
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error(error);
                alert("Error creating playlist.");
            }
        });
    });

    </script>
</body>
</html>
